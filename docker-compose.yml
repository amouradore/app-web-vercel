version: '3.8'
services:
  backend:
    build: ./backend
    container_name: acestream-backend
    ports:
      - "8000:8000"
    environment:
      - ACESTREAM_BASE_URL=${ACESTREAM_BASE_URL:-http://engine:6878}
      - STORAGE_DIR=/app/storage
      - HLS_PUBLIC_BASE=${HLS_PUBLIC_BASE:-}
    volumes:
      - ./backend/storage:/app/storage
    depends_on:
      engine:
        condition: service_healthy

  engine:
    # Image communautaire (POC). Utilisez votre propre image si possible.
    image: romancin/acestream-engine:latest
    container_name: acestream-engine
    restart: unless-stopped
    ports:
      - "6878:6878"
    environment:
      - UID=1000
      - GID=1000
    healthcheck:
      test: ["CMD", "bash", "-lc", "exec 3<>/dev/tcp/127.0.0.1/6878 && echo -e 'GET /webui/api/service?method=get_version HTTP/1.1\r\nHost: localhost\r\n\r\n' >&3 && sleep 1 && head -n 1 <&3 | grep -q 'HTTP/1.1' "]
      interval: 20s
      timeout: 5s
      retries: 10
    volumes:
      - ./engine/data:/data
    # Si vous avez votre propre image, remplacez la ligne `image:` par `build: ./engine`

# Optionnel: un reverse-proxy Nginx/CDN pour exposer /hls
